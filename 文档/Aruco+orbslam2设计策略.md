# 单目相机Aruco+ORBSLAM2的设计策略

## Aruco策略

### 1.跟踪线程

#### 1.1初始化

允许同时使用keypoint和marker初始化，其中任意一个初始化成功就算是初始化成功，优先取marker初始化的那个结果。（一些理论有待解决）

#### 1.2跟踪相机位姿

##### 1.2.1跟踪时的匹配关系

**Aruco码的匹配关系**：有两种Aruco码不会用于追踪：无效的和要参与回环检测的。Aruco匹配时，是将四个角点重投影到图像上，和特征点的匹配类似。

##### 1.2.2跟踪时的相机位姿估计

在跟踪线程中，相机的位姿估计有两次：第一次是利用**运动模型**、**参考关键帧**或者**重定位**来初步估计位姿，第二次是利用局部关键帧观察到的局部map point和marker投影到当前帧来估计位姿。

不论是哪一次，都是需要用最小化重投影误差来求解位姿。第一次时只用到了和上一帧（或别的参考帧，但是只有一帧）匹配到的map point和marker corner，而第二次使用的是局部map point和marker corner来投影的。

最小化重投影的损失函数中，对marker corner和map point有不同的权重。marker corner的权重的计算为：

<img src="C:\Users\交大得E门生\AppData\Roaming\Typora\typora-user-images\image-20210822153856369.png" alt="image-20210822153856369" style="zoom: 67%;" />

其中$n_f$是这一帧中有效的marker的数量，$τ_m$是一个阈值。

#### 1.3关键帧插入

这里只涉及二维码相关的关键帧插入，orbslam2中的原策略不改变。

1. 如果当前帧中发现了一个以前没见过的新的二维码，就把二维码插入地图，同时把当前帧设置为关键帧。如果这个二维码的位姿没有被有效估计出来，就先置为无效，等之后再来估计。
2. 如果当前帧中至少有一个二维码在地图中是无效的，并且在当前帧中可以有效的估计出它，那么就添加这一帧为关键帧。
3. 如果当前帧包含至少一个二维码，并且该帧到上一个最近的关键帧的距离大于阈值$τ_b$​，就添加这一帧为关键帧。
4. 如果当前帧的匹配到的地图点的数量低于参考关键帧中的匹配到的地图点总数的百分比$τ_k$就添加当前帧为关键帧。

### 2.局部建图线程

#### 2.1处理新关键帧

#### 2.2二维码剔除

#### 2.3恢复新二维码位姿

#### 2.4融合新二维码

#### 2.5局部BA优化（优化局部关键帧和局部二维码位姿）

#### 2.6局部关键帧剔除

每个二维码需要被至少三个关键帧观测到，所以对于每一个二维码，可以从观察到这些二维码的关键帧中选择三个相互距离最大的关键帧，这三个关键帧是不能被剔除的。而对于其他那些关键帧，就用orbslam2中的方法进行剔除。

### 3.回环检测线程

