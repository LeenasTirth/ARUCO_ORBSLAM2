# 流程细节

## 跟踪线程

### 若没有初始化

### 若已经初始化

**流程**：

1. 接受一帧图像，进行预处理：

   检测出图片上的marker，计算出每一个marker的$γ^t_m$。

   每一个frame维护一个map<id,pair<Mat,Mat>>ambiguity变量，pair的第二个元素为空则表示无歧义，否则为有歧义。

   如果发现了新的marker就将这个marker加入marker数据集，并且置为无效。（无效marker只有在局部建图线程才会恢复为有效）

2. 利用以下某一方法对相机位姿进行初步估计：

      - **利用恒速运动模型**：利用恒速运动模型得到一个初步的位姿，然后用**上一帧的地图点**和**这一帧检测到的有效的marker**投影到该帧进行最小化重投影。
      - **利用参考关键帧**：如果当前帧观测到了**有效且非歧义**的marker就先估计一个初始位姿，否则用上一帧的位姿作为初始位姿。然后将参考关键帧的特征点和当前帧的特征点进行匹配，然后将参考关键帧特征点对应的地图点和这一帧检测到的有效的marker投影到当前帧上，进行最小化重投影。
       - **利用重定位**：如果当前帧检测到了**有效且非歧义**的marker（任取一个即可），就可以直接用公式$γ^t_m*γ_m^{-1}$​​得到相机的一个初步位姿，然后用orbslam2的方法；如果当前帧没有检测到**有效且非歧义**的marker，就按照orbslam2的方法。

3. 利用局部地图点和观测到的有效且非歧义marker重投影到当前关键帧，最小化重投影误差。

4. 选关键帧，满足以下任意要求：

   - 若当前帧发现了新二维码，就插入为关键帧。
   - 若当前帧包含至少一个旧的无效的二维码，但是这一个二维码对这一帧来说是无歧义观测到的，则插入为关键帧。
   - 若当前帧包含至少一个二维码，并且和上一个关键帧距离大于阈值$τ_b$，则插入为关键帧。
   - 和orbslam2一样。



## 局部建图线程

**流程**：

1. 每次循环取出队列中第一个关键帧。
2. 对该关键帧，遍历关键帧中的所有无效二维码，将其中的无歧义的直接用$γ_m=(γ^t)^{-1}*γ^t_m$​恢复其位姿并置为有效，将其中的有歧义的添加到list\<ArucoMarker*\> mlpRecentAddedMarkers中。（只在第一次被发现的时候加入，避免重复加入）
3. 遍历mlpRecentAddedMarkers链表，如果发现当前这个marker被置为有效了，将其中链表中踢出，否则，当有三个关键帧观测到这一个marker时，恢复它的位姿，将其置为有效，然后从链表中踢出。
4. 局部BA优化
5. 剔除关键帧，策略：
      - 对于每一个二维码，在marker数据库中维护一个集合。该集合中的元素表示不能剔除的关键帧。这些关键帧是——对于每个marker来说，它们的观测者中相互距离最大的三个关键帧不能被删除。（这里还有待考虑）
      - 然后遵照orbslam2中的策略删除。



## 闭环检测线程

回环检测分为两种情况，一种是利用地图点发现的回环，一种是利用二维码发现的回环。

前者的发生在LoopClosing线程中，属于orbslam2的正常步骤；后者的检测阶段发生在Tracking线程中，矫正阶段发生在LoopClosing线程中。

下面是**利用二维码回环的流程**：

1. 在估计完当前帧位姿之后，在判断是否插入关键帧之前，判断这一帧是否通过二维码检测到回环：如果当前帧中检测到了一个以前的出现过的有效marker，并且这一个marker在它的所有**邻居关键帧**（除这个marker以外）中都没有出现，就认为当前这一帧检测到了回环。
2. 若检测到了回环，就把当前帧作为关键帧插入localmapping线程，然后叫停localmapping线程（或者是localmapping到这一关键帧时再叫停）；若没有检测到回环，就退出这个步骤，按正常orbslam2流程来。
3. 对当前这个关键帧，利用发现回环的marker再计算一次位姿，然后求这一个位姿和正常tracking得到的位姿的相对变化，作为sim3（？），然后按照orbslam2中的矫正方法纠正。然后进行全局优化。

